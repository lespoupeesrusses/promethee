
<script type="text/javascript">
promethee
  .directive('draggable', function() {
    return {
      restrict:'A',
      link: function(scope, element, attrs) {
        element.draggable({
          revert: true,
          revertDuration: 0,
          scroll: true,
          refreshPositions: true,
          cursor: 'move', 
          start: function() {
            var $elementDragged = $(element[0]);
            var type = $elementDragged.data('type');
            $('.promethee-edit__move').addClass('promethee-edit__move--dragging promethee-edit__move--dragging--' + type);

            // The droppable zone immediately before has no use, it would put the object at the same position
            // FIXME the selector is not correct
            /*
            var $droppableBefore = $elementDragged.prev('.promethee-edit__move__draggable').find('.promethee-edit__move__droppable').last();
            if ($droppableBefore.length === 0) {
              // For the first child, we look for the previous droppable zone
              $droppableBefore = $elementDragged.prev('.promethee-edit__move__droppable');
            }
            $droppableBefore.addClass('promethee-edit__move__droppable--hidden');
            */
          },
          stop: function() {
            var $elementDragged = $(element[0]);
            var type = $elementDragged.data('type');
            $('.promethee-edit__move').removeClass('promethee-edit__move--dragging promethee-edit__move--dragging--' + type);
            // $('.promethee-edit__move__droppable').removeClass('promethee-edit__move__droppable--hidden');
          }
        });
      }
    }
  })
  .directive('droppable', function($compile) {
    return {
      restrict: 'A',
      link: function(scope, element, attrs) {
        element.droppable({
          tolerance: 'pointer',
          drop: function(event, ui) {
            var draggedFromList = angular.element(ui.draggable).parent().scope().components;
            var draggedFromIndex = parseInt(ui.draggable[0].getAttribute('data-index'));
            // console.log('dragged', draggedFromList, draggedFromIndex);
            draggedFromList.splice(draggedFromIndex, 1);

            var component = angular.element(ui.draggable).scope().component;
            var droppedToList = angular.element(this).scope().components;
            var droppedToIndex = parseInt(this.getAttribute('data-index'));
            if (draggedFromList == droppedToList) {
              // The object we dragged was removed from the list
              if (draggedFromIndex < droppedToIndex) {
                // It was before the dropped index, so removing it changed the index
                droppedToIndex -= 1;
              }
            }
            // console.log('dropped', component, droppedToList, droppedToIndex);
            droppedToList.splice(droppedToIndex, 0, component);

            scope.$apply();
          }
        });
      }
    }
  });
</script>

<div class="promethee-edit__move" ng-show="promethee.mode == 'move'">
  <div class="promethee-edit__move__columns row">
    <% 12.times do %>
      <div class="col col-md-1"><div class="color"></div></div>
    <% end %>
  </div>
  <div class="promethee-edit__move__page">
    <ng-include src="'promethee/move/components'"></ng-include>
  </div>
</div>

<script type="text/ng-template" id="promethee/move/component">
  <div class="promethee-edit__move__component">
    <ng-include src="'promethee/components/' + component.type + '/edit/move'"></ng-include>
  </div>
</script>

<script type="text/ng-template" id="promethee/move/components">
  <div ng-init="type = component.type; components = component.children">
    <div 
      droppable
      class=" promethee-edit__move__droppable 
              promethee-edit__move__droppable--{{type}} 
              promethee-edit__move__droppable--{{type}}--first"
      data-index="0"
      >
    </div>
    <div
      draggable
      ng-repeat="component in components"
      class=" promethee-edit__move__draggable
              promethee-edit__move__draggable--{{type}}"
      data-index="{{$index}}"
      data-type="{{component.type}}"
      >
      <ng-include src="'promethee/move/component'"></ng-include>
      <div
        droppable
        class=" promethee-edit__move__droppable 
                promethee-edit__move__droppable--{{type}}"
        data-index="{{$index+1}}"
        data-type="{{type}}"
        >
      </div>
    </div>
  </div>
</script>
