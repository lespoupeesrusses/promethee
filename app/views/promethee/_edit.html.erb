<%
promethee_data = Promethee::Data.new master_data
preview_url ||= promethee_preview_path
back_url ||= nil
logo = File.read "#{__dir__}/../../assets/images/icon-promethee.svg"
%>

<script type="text/javascript">
var promethee = angular
  .module('Promethee', ['summernote', 'ngAnimate', 'ngFileUpload', 'ui.sortable', 'colorpicker.module'], ['$rootScopeProvider', function($rootScopeProvider) {
    $rootScopeProvider.digestTtl(30);
  }])
  .value('definitions', [])
  .value('presets', []);
</script>

<% promethee_util_partials.each do |partial| %>
  <%= render partial %>
<% end %>

<% promethee_preset_partials.each do |partial| %>
    <%= render partial %>
<% end %>

<script type="text/javascript">
promethee.controller('PrometheeController', ['$scope', 'summernoteConfig', 'presets', '$filter', function($scope, summernoteConfig, presets, $filter) {

  $scope.generateIdentifier = function() {
    // https://stackoverflow.com/questions/105034/create-guid-uuid-in-javascript
    function s4() {
      return Math.floor((1 + Math.random()) * 0x10000)
        .toString(16)
        .substring(1);
    }
    return s4() + s4() + '-' + s4() + '-' + s4() + '-' + s4() + '-' + s4() + s4() + s4();
  }

  $scope.data = <%= promethee_data.to_json.html_safe %>;

  // Data (TODO use standard method createComponentFromDefinition)
  if (typeof $scope.data !== 'object' || $scope.data === null || $scope.data.type !== 'page') {
    $scope.data = {
      id: $scope.generateIdentifier(),
      type: 'page',
      attributes: {
        searchable_title: 'New page',
        searchable_description: '',
        stylesheets: '',
        javascripts: ''
      },
      children: []
    };
  }

  $scope.promethee = {
    data: $scope.data,
    definitions: [],
    presets: presets,
    inspected: $scope.data,
    mode: 'move',
    preview: 'desktop',
    fullscreen: true
  };

  $scope.findDefinitionByType = function(type) {
    return $filter('filter')($scope.promethee.definitions, {'data':{'type':type}})[0];
  }

  $scope.addComponentByType = function(type, target, index = -1) {
    var definition = $scope.findDefinitionByType(type);
    $scope.addComponent(definition, target, index);
  }

  $scope.addComponent = function(definition, target, index = -1) {
    var component = $scope.createComponentFromDefinition(definition);
    if (index === -1) {
      target.push(component);
    } else {
      target.splice(index, 0, component);
    }
  }

  $scope.createComponentFromDefinition = function(definition) {
    var component = angular.copy(definition.data);
    component.id = $scope.generateIdentifier();
    return component;
  }

  $scope.inspect = function(component, event) {
    if(event.target.closest('.promethee-edit__component') === event.currentTarget) {
      $scope.promethee.inspected = component;
    }
  }

  $scope.enablePreview = function() {
    if (this.promethee.mode === 'preview') return;
    this.promethee.mode = 'preview';
    this.sendPreviewData('preview');
  }

  $scope.sendPreviewData = function(target) {
    var form = document.createElement('form');
    document.body.appendChild(form);
    form.method = 'POST';
    form.action = "<%= preview_url %>";
    form.target = target;

    var input = document.createElement('input');
    input.type = 'text';
    input.value = JSON.stringify($scope.promethee.data);
    input.name = 'data';
    form.appendChild(input);

    <% if defined?(preview_layout) %>
    var layoutInput = document.createElement('input');
    layoutInput.type = 'text';
    layoutInput.value = "<%= preview_layout %>";
    layoutInput.name = 'preview_layout';
    form.appendChild(layoutInput);
    <% end %>

    form.submit();
    document.body.removeChild(form);
  }

  $scope.remove = function(component, components) {
    var index = components.indexOf(component);
    components.splice(index, 1);
    this.promethee.inspected = null;
  }

  $scope.submit = function() {
    $('#promethee').closest('form').submit();
  };

  $scope.summernoteConfig = summernoteConfig;
  $scope.sendPreviewData('thumb-preview');
}]);
</script>

<div class="promethee-loader">
  <div class="promethee-loader__inner"><%= image_tag 'loader.gif' %></div>
</div>

<div  id="promethee"
      ng-app="Promethee"
      ng-controller="PrometheeController as prometheeController"
      ng-init="component = promethee.data"
      class="ng-cloak">

  <% promethee_template_partials.each do |partial| %>
    <%= render partial %>
  <% end %>

  <div class="promethee-open" ng-click="promethee.fullscreen = true">
    <div class="promethee-open__logo"><%= logo.html_safe %></div>
    <div>Click to edit page</div>
    <iframe class="promethee-open__thumb-preview" id="thumb-preview" name="thumb-preview"></iframe>
  </div>

  <div class="promethee-edit" ng-show="promethee.fullscreen">
    <input type="hidden" name="page[data]" id="page_data" value="{{promethee.data}}" />
    <div class="upload__modal" ng-show="upload.running">

    </div>
    <nav class="navbar navbar-default promethee-edit__navbar" ng-class="{'navbar-fixed-top': promethee.fullscreen }">
      <div class="container-fluid">
        <div class="navbar-header promethee-edit__icon">
          <div class="navbar-brand"><%= logo.html_safe %></div>
        </div>
        <div id="navbar">
          <ul class="nav navbar-nav navbar-right">
            <li ng-click="promethee.mode = 'move'" ng-class="{active: promethee.mode == 'move'}"><a><%= fa_icon :pencil %></a></li>
            <li ng-click="enablePreview()" ng-class="{active: promethee.mode == 'preview'}">
              <a data-toggle="dropdown"><%= fa_icon :eye %></a>
              <ul class="dropdown-menu" ng-show="promethee.mode == 'preview'">
                <li ng-click="promethee.preview = 'desktop'"
                    ng-class="{active: promethee.preview == 'desktop'}">
                    <a><i class="fa fa-desktop"></i></a></li>
                <li ng-click="promethee.preview = 'tablet'"
                    ng-class="{active: promethee.preview == 'tablet'}">
                    <a><i class="fa fa-tablet"></i></a></li>
                <li ng-click="promethee.preview = 'mobile'"
                    ng-class="{active: promethee.preview == 'mobile'}">
                    <a><i class="fa fa-mobile"></i></a></li>
              </ul>
            </li>
            <li ng-click="submit()"><a><%= fa_icon :save %></a></li>
            <% if back_url.present? %>
              <li><%= link_to fa_icon(:close).html_safe, back_url %></li>
            <% else %>
              <li ng-click="promethee.fullscreen = false"><a><%= fa_icon :close %></a></li>
            <% end %>
          </ul>
        </div>
      </div>
    </nav>

    <% promethee_component_partials.each do |partial| %>
      <%= render partial %>
    <% end %>

    <%= render 'promethee/edit/move' %>
    <%= render 'promethee/edit/preview' %>
  </div>
</div>
